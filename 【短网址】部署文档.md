# 小宝短网址【LYXPHPUrlsServer】项目部署文档



### 项目说明

> 小宝短网址【LYXPHPUrlsServer】项目是营销云分销项目服务端，项目基于LGFrameworkV2.0版本构建,项目核心采用PHP实现长链接转短网址服务，提供API、后台、WEB服务。项目依赖Redis，采用redis实现悲观锁进行并发控制，以及缓存实现，项目子项目主要包含：
>
> - API接口服务层(api)：短网址服务api接口
> - 管理后台：短链管理、后台用户管理、访问权限管理、黑名单等
> - WEB服务：提供免费生成短链服务，批量生成等
> - 短域名跳转服务：用于对生成的短链接进行跳转（）



### 项目地址

#### 源代码Git地址：

> ```powershell
> ssh://git@git-lyx.51lick.cn:8082/LYXPHPUrlsServer.git （修改掉）
> ```



#### 项目目录和访问配置关系

| 名称          | 域名(http\|https)                                            | 内网IP          | 项目目录                             | 备注 |
| ------------- | ------------------------------------------------------------ | --------------- | ------------------------------------ | ---- |
| API接口服务层 | urls-api.51lick.com                                          | 10.23.141.41-44 | ./site/api/webroot                   |      |
| 管理后台      | urls-admin.51lick.com                                        | 10.23.141.41-44 | ./site/backend/webroot               |      |
| WEB服务       | urls.51lick.com                                              | 10.23.141.41-44 | ./site/www/webroot                   |      |
| 短域名服务    | 9jc.co<br/>5xs.co<br/>1lx.co<br/>lyx0.cn<br/>8lyx.cn<br/>lyx5.cn | 10.23.141.41-44 | ./site/www/webroot<br>/urls_entrance |      |


### 项目配置

> 初始项目时保证项目site下的api、backend、www目录下存在action_templates_c、runtime目录,Linux环境建议执行：
>
> ```powershell
> cd /path/LYXPHPUrlsServer
> mkdir -p site/{api,backend,www}/{action_templates_c,runtime}
> ```
>
> #### 配置项目公共文件
>
> - cp ./common/conf/DBConfig.php~sample ./common/conf/DBConfig.php 配置内容：
>
>   ```php+HTML
>   <?php
>   /**
>    * 系统配置文件
>    * 
>    */
>               
>   define("LG_MYSQL_MODE",'multi'); //数据库模式：single-单数据库模式;multi-主从，多数据模式
>   if(LG_MYSQL_MODE=="multi"){
>       //mysql数据主库配置文件(Master)
>       define("LG_MYSQL_MASTERS",[
>           [
>               'host'=>'10.23.141.98',
>               'username'=>'root',
>               'password'=>'lyx@20161111',
>               'db'=>'lyx_urls_prod',
>               'port'=>'3306',
>               'charset'=>'utf8'
>           ]
>       ]);
>               
>       //mysql数据从配置文件(Slave)
>       define("LG_MYSQL_SLAVES",[
>           [
>               'host'=>'10.23.141.98',
>               'username'=>'root',
>               'password'=>'lyx@20161111',
>               'db'=>'lyx_urls_prod',
>               'port'=>'3306',
>               'charset'=>'utf8'
>           ],
>       ]);
>   }else{
>       //mysql数据库配置文件，可修改
>       define("LG_MYSQL_HOST","127.0.0.1");
>       define("LG_MYSQL_USER","root");
>       define("LG_MYSQL_PASS","123");
>       define("LG_MYSQL_DBNAME","lyx_urls");
>       define("LG_MYSQL_PORT","3306");
>       define("LG_MYSQL_CHARSET","utf8");
>   }
>             
>   //定义Memcache配置
>   define('LG_MEMCACHE_HOST', 'localhost');
>   define('LG_MEMCACHE_PORT', 11211);
>   define('LG_MEMCACHE_EXPIRATION', 0);
>   define('LG_MEMCACHE_PREFIX', 'iliangcang');
>   define('LG_MEMCACHE_COMPRESSION', FALSE);
>             
>     //定义Redis配置
>   define('LG_REDIS_HOST', "10.23.141.73");
>   define('LG_REDIS_PORT', 6379);
>   define('LG_REDIS_AUTH', 'lyx123456');
>       
>   //定义MongoDB配置
>   define('LG_MONGODB_URI', "mongodb://127.0.0.1:27017");
>   define('LG_MONGODB_URIOPTIONS', []);
>   define('LG_MONGODB_DRIVEROPTIONS', []);
>   define('LG_MONGODB_NAME', 'xbam');
>     
>   //用户中心JAVA的URL
>   define('LG_UCENTER_URL', 'http://10.23.141.11:8800');
>   //智慧运营Java接口的URL
>   define('LG_ZSERVER_URL', 'https://zs-api.51lick.com');
>     
>   ```
>
>   
>
> - cp ./common/conf/Params.php~sample ./common/conf/Params.php 配置内容：
>
>   ```php+HTML
>   <?php
>   /**
>    * params.php
>    * ==============================================
>    * Copy right 2014-2019  by Gaorrunqiao
>    * ----------------------------------------------
>    * This is not a free software, without any authorization is not allowed to use and spread.
>    * ==============================================
>    * @desc : 项目配置文件
>    *        调用方式：
>    *        $key = LG::$params('key');
>    * @author: goen<goen88@163.com>
>    * @date: 2019/5/27
>    * @version: v2.0.0
>    * @since: 2019/5/27 6:17 PM
>    */
>       
>   return array(
>       /*'shortUrls' => [
>           "http://9jc.co/",
>           "http://5xs.co/",
>           "http://1lx.co/",
>           "http://lyx0.cn/",
>           "http://8lyx.cn/",
>           "http://lyx5.cn/",
>       ],*/
>       'hashIds'     => [
>           'salt'     => 'a517bbe9b853666f4cc2d9f080c1402db25b22bb',
>           'length'   => 3,
>           'alphabet' => 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890',
>       ],
>   );
>   ```
>
>   
>
> #### API项目配置
>
> - site/api/conf/conf_const_var.php
>
> ```php
> <?php
> /**
>  * conf_const_var.php
>  * ==============================================
>  * Copy right 2015-2017  by http://backend.51lick.com
>  * ----------------------------------------------
>  * This is not a free software, without any authorization is not allowed to use and spread.
>  * ==============================================
>  * @desc :
>  * @author: goen<goen88@163.com>
>  * @date: 2017/6/15
>  * @version: v2.0.0
>  * @since: 2017/6/15 19:27
>  */
> 
> //系统工程目录
> if(!defined("LG_ROOT")){
>     define("LG_ROOT", dirname(dirname(dirname(dirname(__FILE__)))) );
> }
> //web根目录
> define("LG_WEB_ROOT", dirname(dirname(__FILE__)) );
> 
> 
> 
> define("LG_DEBUG",true);
> 
> define("LG_TEMPLATES_ENGINE",true);
> 
> //是否开启myql数据库，默认开启】
> define("LG_DB_MYSQL",true);
> 
> //开启Redis
> define("LG_DB_REDIS",true);
> 
> #define("LG_ACTION_SUBFIX",'Controller.php');
> 
> 
> require_once(LG_ROOT.'/common/config/Bootstrap.php');
> 
> require_once(LG_WEB_ROOT.'/vendor/autoload.php');
> ```
>
> 
>
> #### 后台配置
>
> - site/backend/conf/conf_const_var.php 
> ```php
> <?php
> /**
>  * conf_const_var.php
>  * ==============================================
>  * Copy right 2015-2017  by http://backend.51lick.com
>  * ----------------------------------------------
>  * This is not a free software, without any authorization is not allowed to use and spread.
>  * ==============================================
>  * @desc :
>  * @author: goen<goen88@163.com>
>  * @date: 2017/6/15
>  * @version: v2.0.0
>  * @since: 2017/6/15 19:27
>  */
> 
> 
> 
> define("LG_IMG_URL", "");
> define("LG_UPLOAD_URL", "");
> define("LG_API_URL", "https://urls-api.51lick.com");
> 
> define("APP_VERSION", "1.0");
> 
> 
> //系统工程目录
> if(!defined("LG_ROOT")){
>     define("LG_ROOT", dirname(dirname(dirname(dirname(__FILE__)))) );
> }
> //web根目录
> define("LG_WEB_ROOT", dirname(dirname(__FILE__)) );
> 
> 
> 
> define("LG_DEBUG",true);
> 
> define("LG_TEMPLATES_ENGINE",true);
> 
> //是否开启myql数据库，默认开启】
> define("LG_DB_MYSQL",true);
> 
> 
> //开启MongoDB，默认关闭
> define('LG_DB_MONGODB',false);
> 
> 
> require_once(LG_ROOT.'/common/config/Bootstrap.php');
> 
> require_once(LG_WEB_ROOT.'/vendor/autoload.php');
> ```
> 
> #### WWW项目
> -  site/www/conf/conf_const_var.php
>```php
> <?php
> /**
>  * conf_const_var.php
>  * ==============================================
>  * Copy right 2015-2017  by http://backend.51lick.com
>  * ----------------------------------------------
>  * This is not a free software, without any authorization is not allowed to use and spread.
>  * ==============================================
>  * @desc :
>  * @author: goen<goen88@163.com>
>  * @date: 2017/6/15
>  * @version: v2.0.0
>  * @since: 2017/6/15 19:27
>  */
> 
> 
> 
> define("LG_IMG_URL", "");
> define("LG_UPLOAD_URL", "");
> define("LG_API_URL", "https://urls-api.51lick.com");
> 
> define("APP_VERSION", "1.0");
> 
> 
> //系统工程目录
> if(!defined("LG_ROOT")){
>     define("LG_ROOT", dirname(dirname(dirname(dirname(__FILE__)))) );
> }
> //web根目录
> define("LG_WEB_ROOT", dirname(dirname(__FILE__)) );
> 
> 
> 
> define("LG_DEBUG",true);
> 
> define("LG_TEMPLATES_ENGINE",true);
> 
> //是否开启myql数据库，默认开启】
> define("LG_DB_MYSQL",false);
> 
> //开启MongoDB，默认关闭
> define('LG_DB_MONGODB',false);
> 
> 
> require_once(LG_ROOT.'/common/config/Bootstrap.php');
> 
> require_once(LG_WEB_ROOT.'/vendor/autoload.php');
> ```
> 
> 



### WebServer配置

- 基于Nginx部署配置
```ini
server{
    listen 18710;
    server_name     127.0.0.1; #urls-api.51lick.com;
    root            /data/web/LYXPHPUrlsServer/site/api/webroot;

    access_log      /data/logs/nginx/urls/urls_api.access_log new ; # buffer=16k;
    error_log       /data/logs/nginx/urls/urls_api.error_log notice;

    index   index.php index.html index.shtml  index.htm;
    location / {
         try_files $uri $uri/ /index.php?$args;
    }


    location ~ \.php$ {
        fastcgi_pass   127.0.0.1:9700;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
        include        fastcgi_params;

    }
}

server{
    listen 18720;
    server_name     127.0.0.1; #urls.51lick.com;   
    root            /data/web/LYXPHPUrlsServer/site/www/webroot;
    
    access_log      /data/logs/nginx/urls/urls_www.access_log new ; # buffer=16k;
    error_log       /data/logs/nginx/urls/urls_www.error_log notice;
    
    index   index.php index.html index.shtml  index.htm;
    location / {
         try_files $uri $uri/ /index.php?$args;
    }

    
    location ~ \.php$ {
	fastcgi_pass   127.0.0.1:9700;
	fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
	include        fastcgi_params;

    }
}

server{
    listen 18730;
    server_name     127.0.0.1; #u.51lick.com;
    root            /data/web/LYXPHPUrlsServer/site/www/webroot/urls_entrance;

    access_log      /data/logs/nginx/urls/urls_short.access_log new ; # buffer=16k;
    error_log       /data/logs/nginx/urls/urls_short.error_log notice;

    index   index.php index.html index.shtml  index.htm;
    location / {
         try_files $uri $uri/ /index.php?$args;
    }


    location ~ \.php$ {
        fastcgi_pass   127.0.0.1:9700;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
        include        fastcgi_params;

    }
}


server{
    listen 18740;
    server_name     127.0.0.1; #urls-admin.51lick.com;
    root            /data/web/LYXPHPUrlsServer/site/backend/webroot;
    
    access_log      /data/logs/nginx/urls/urls_admin.access_log new ; # buffer=16k;
    error_log       /data/logs/nginx/urls/urls_admin.error_log notice;
    
    index.php index.html index.shtml  index.htm;
    location / {
         try_files $uri $uri/ /index.php?$args;
    }


    location ~ \.php$ {
        fastcgi_pass   127.0.0.1:9700;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
        include        fastcgi_params;

    }
}
```
